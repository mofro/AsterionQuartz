name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'  # Quartz requires Node.js >= 22
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Install all dependencies
          npm install

      - name: Setup Quartz content and styles
        run: |
          # Remove any broken symlinks
          if [ -L "content" ] && [ ! -e "content" ]; then
            echo "Removing broken symlink..."
            rm content
          fi
          
          # If content doesn't exist, create it and copy from obsidian
          if [ ! -e "content" ]; then
            echo "Creating content directory and copying from obsidian..."
            mkdir -p content
            cp -r obsidian/* content/ || true
          elif [ -d "content" ]; then
            echo "Content directory exists, syncing with obsidian..."
            rsync -a --delete obsidian/ content/ || true
          fi
          
          # Ensure static directory exists
          mkdir -p static/styles
          
          # Copy custom SCSS file if it exists
          if [ -f "custom.scss" ]; then
            cp custom.scss static/styles/ || true
          else
            echo "No custom.scss found, using default styles"
          fi
          
          # Create a simple plugin to inject our CSS
          mkdir -p quartz/plugins/custom
          echo 'import { QuartzTransformerPlugin } from "../types"
          
          export const CustomCSS: QuartzTransformerPlugin = () => ({
            name: "CustomCSS",
            htmlPlugins() {
              return [
                () => (tree: any) => {
                  const head = tree.children.find((child: any) => 
                    child.type === "element" && child.tagName === "head"
                  )
                  
                  if (head) {
                    head.children.push({
                      type: "element",
                      tagName: "link",
                      properties: {
                        rel: "stylesheet",
                        href: "/css/custom.css"
                      },
                      children: []
                    })
                  }
                }
              ]
            }
          })' > quartz/plugins/custom/css.ts
          
          # Update the config to include our custom plugin
          sed -i 's/transformers: \[/transformers: [\n      CustomCSS(),/' quartz.config.ts
          sed -i 's|import { QuartzConfig } from "./quartz/cfg"|import { QuartzConfig } from "./quartz/cfg"\nimport { CustomCSS } from "./quartz/plugins/custom/css"|' quartz.config.ts
          
      - name: Update Quartz configuration
        run: |
          # Update just the baseUrl in the config (matching the exact format)
          sed -i 's|baseUrl: "[^"]*"|baseUrl: "${{ github.event.repository.name }}"|' quartz.config.ts
          
          # Verify the config was updated

      - name: Build and prepare site
        env:
          BASE_URL: "${{ github.event.repository.name }}"
        run: |
          set -e  # Exit on error
          
          # 1. Build the site
          echo "ğŸš€ Building site with base directory: $BASE_URL"
          npx quartz build --baseDir "$BASE_URL" --verbose
          
          # 2. Handle custom styles if they exist
          if [ -d "src/styles" ]; then
            echo "ğŸ¨ Processing custom styles..."
            mkdir -p public/css
            
            # Compile SCSS if sass is available
            if command -v sass >/dev/null 2>&1; then
              # Compile SCSS to CSS
              sass src/styles/:public/css/
              
              # Add link to custom styles in the HTML head
              if [ -f "public/index.html" ]; then
                echo "ğŸ“ Adding custom styles to index.html..."
                sed -i.bak '/<head>/a\    <link href="/css/custom.css" rel="stylesheet" />' public/index.html
                rm -f public/index.html.bak
              fi
            else
              echo "âš ï¸  sass command not found. Skipping SCSS compilation."
            fi
          fi
          
          # 3. Copy static assets if they exist
          if [ -d "static" ]; then
            echo "ğŸ“ Copying static assets..."
            mkdir -p public/static
            cp -r static/* public/static/ 2>/dev/null || true
          fi
          
          # 4. Prepare for deployment
          echo "ğŸ“¦ Preparing for deployment..."
          
          # Ensure .nojekyll is present for SPA routing
          touch public/.nojekyll
          
          # Verify build output
          echo "ğŸ“‚ Build output:"
          ls -la public/
          echo "ğŸ“ Static assets:"
          ls -la public/static/ || echo "No static assets found"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

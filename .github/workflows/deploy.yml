name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'  # Quartz requires Node.js >= 22
          cache: 'npm'

      - name: Install dependencies
        run: |
          # Install all dependencies
          npm install

      - name: Setup Quartz content and styles
        run: |
          # Remove any broken symlinks
          if [ -L "content" ] && [ ! -e "content" ]; then
            echo "Removing broken symlink..."
            rm content
          fi
          
          # If content doesn't exist, create it and copy from obsidian
          if [ ! -e "content" ]; then
            echo "Creating content directory and copying from obsidian..."
            mkdir -p content
            cp -r obsidian/* content/ || true
          elif [ -d "content" ]; then
            echo "Content directory exists, syncing with obsidian..."
            rsync -a --delete obsidian/ content/ || true
          fi
          
          # Ensure static directory exists
          mkdir -p static/styles
          
          # Copy custom SCSS file if it exists
          if [ -f "custom.scss" ]; then
            cp custom.scss static/styles/ || true
          else
            echo "No custom.scss found, using default styles"
          fi
          
          # Create a simple plugin to inject our CSS
          mkdir -p quartz/plugins/custom
          echo 'import { QuartzTransformerPlugin } from "../types"
          
          export const CustomCSS: QuartzTransformerPlugin = () => ({
            name: "CustomCSS",
            htmlPlugins() {
              return [
                () => (tree: any) => {
                  const head = tree.children.find((child: any) => 
                    child.type === "element" && child.tagName === "head"
                  )
                  
                  if (head) {
                    head.children.push({
                      type: "element",
                      tagName: "link",
                      properties: {
                        rel: "stylesheet",
                        href: "/css/custom.css"
                      },
                      children: []
                    })
                  }
                }
              ]
            }
          })' > quartz/plugins/custom/css.ts
          
          # Update the config to include our custom plugin
          sed -i "s/transformers: \[/transformers: [\n      CustomCSS(),/" quartz.config.ts
          sed -i "s/import { QuartzConfig } from ".\/quartz\/cfg"/import { QuartzConfig } from ".\/quartz\/cfg"\nimport { CustomCSS } from ".\/quartz\/plugins\/custom\/css"/" quartz.config.ts
          
      - name: Update Quartz configuration
        run: |
          # Update just the baseUrl in the config (matching the exact format)
          sed -i 's|baseUrl: "[^"]*"|baseUrl: "${{ github.event.repository.name }}"|' quartz.config.ts
          
          # Verify the config was updated
          echo "Updated Quartz configuration:"
          grep -A 3 "baseUrl" quartz.config.ts
          
          echo "\nActive emitters:"
          grep -A 15 "emitters:" quartz.config.ts | grep -v "^\s*//" | head -n 15

      - name: Build site
        env:
          BASE_URL: "${{ github.event.repository.name }}"
        run: |
          # Build the site with the custom base URL
          echo "Building site with BASE_URL: $BASE_URL"
          npx quartz build --baseUrl "$BASE_URL" --verbose
          
          # Verify build output
          echo "Build output:"
          ls -la public/
          
          # Copy custom styles to the public directory
          if [ -d "src/styles" ]; then
            echo "Copying custom styles to public directory..."
            mkdir -p public/css
            
            # Compile SCSS to CSS
            if command -v sass &> /dev/null; then
              for scss_file in src/styles/*.scss; do
                if [ -f "$scss_file" ]; then
                  css_file="public/css/$(basename "$scss_file" .scss).css"
                  echo "Compiling $scss_file to $css_file"
                  sass "$scss_file" "$css_file"
                fi
              done
              
              # Add link to custom styles in the HTML head
              if [ -f "public/index.html" ]; then
                echo "Adding custom styles to index.html..."
                STYLES_LINK='<link href="/css/custom.css" rel="stylesheet" />' 
                sed -i.bak "s|</head>|$STYLES_LINK\n</head>|" public/index.html
                rm -f public/index.html.bak
                echo "Updated index.html with custom styles"
              fi
            else
              echo "Warning: sass command not found. Skipping SCSS compilation."
            fi
          else
            echo "Warning: No src/styles directory found. Skipping custom styles."
          fi

      - name: Move build output to root
        run: |
          # Move the built files to the root of the workspace
          mv node_modules/@jackyzha0/quartz/public/* .
          # Ensure .nojekyll is present (for SPA routing)
          touch .nojekyll
          
          # Verify the files were moved
          echo "Current directory structure:"
          ls -la
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

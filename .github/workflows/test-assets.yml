name: Test Asset Deployment

on:
  workflow_dispatch:

jobs:
  test-assets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Show directory structure
        run: |
          echo "=== Current Directory Structure ==="
          find . -type d -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/.github/*" | sort
          echo ""

      - name: Find all image files
        run: |
          echo "=== All Image Files ==="
          find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) \
                 -not -path "*/node_modules/*" \
                 -not -path "*/.git/*" \
                 -not -path "*/.github/*" | sort
          echo ""

      - name: Build Quartz site
        run: npx quartz build

      - name: Verify public directory structure
        run: |
          echo "=== Public Directory Structure ==="
          if [ -d "public" ]; then
            find public -type f | sort
            echo ""
            echo "=== Public Directory Size ==="
            du -sh public/
            echo ""
            echo "=== Top 10 Largest Files ==="
            find public -type f -exec du -h {} + | sort -rh | head -n 10
          else
            echo "❌ No public directory found after build!"
          fi
          echo ""

      - name: Manual Asset Copy with Verification
        run: |
          echo "=== Starting Manual Asset Copy ==="
          
          # Create necessary directories
          mkdir -p public/static/{images,css,js}
          
          # Define source directories to check
          SOURCES=(
            "assets/images"
            "assets"
            "static/images"
            "static"
            "quartz/static/images"
            "quartz/static"
            "quartz/public/static"
            "public/static"
          )
          
          # Copy and verify each source
          for src in "${SOURCES[@]}"; do
            if [ -d "$src" ] || [ -f "$src" ]; then
              echo "\n=== Processing $src ==="
              echo "Contents of $src:"
              find "$src" -type f 2>/dev/null | head -n 10 || echo "  (empty or not found)"
              
              echo "\nCopying from $src to public/static/..."
              mkdir -p "public/static/$(dirname "$src")"
              cp -rv "$src" "public/static/" 2>/dev/null || echo "  (copy failed or not needed)"
            fi
          done
          
          # Verify final structure
          echo "\n=== Final Public/Static Structure ==="
          find public/static -type f | sort
          
          echo "\n=== Verifying Key Files ==="
          check_file() {
            if [ -f "$1" ]; then
              echo "✅ Found: $1"
              return 0
            else
              echo "❌ Missing: $1"
              return 1
            fi
          }
          
          check_file "public/static/logo.png"
          check_file "public/static/images/logo.png"
          check_file "public/static/css/custom.css"
          check_file "public/index.html"

      - name: Test HTTP Server
        run: |
          echo "=== Starting HTTP Server Test ==="
          cd public
          python3 -m http.server 8080 &
          SERVER_PID=$!
          sleep 2
          
          echo "\n=== Testing Endpoints ==="
          test_endpoint() {
            echo -n "Testing $1: "
            if curl -I -s -o /dev/null -w "%{http_code}" "http://localhost:8080$1" | grep -q "200"; then
              echo "✅ OK"
              return 0
            else
              echo "❌ Failed"
              return 1
            fi
          }
          
          test_endpoint "/static/logo.png" || true
          test_endpoint "/static/images/logo.png" || true
          test_endpoint "/css/custom.css" || true
          test_endpoint "/index.html" || true
          
          # Kill the server
          kill $SERVER_PID

      - name: Generate Summary
        run: |
          echo "=== Test Summary ==="
          echo "Public directory exists: $([ -d "public" ] && echo "✅" || echo "❌")"
          echo "logo.png found: $([ -f "public/static/logo.png" ] || [ -f "public/static/images/logo.png" ] && echo "✅" || echo "❌")"
          echo "CSS files found: $(find public -name "*.css" | wc -l)"
          echo "Image files found: $(find public -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.gif" | wc -l)"
          echo "HTML files found: $(find public -name "*.html" | wc -l)"

      - name: Upload public directory
        uses: actions/upload-artifact@v4
        with:
          name: public-dir
          path: public/
          retention-days: 1

      - name: Verify built site
        run: |
          echo "=== Starting HTTP Server ==="
          cd public
          python3 -m http.server 8080 &
          SERVER_PID=$!
          sleep 2
          
          echo "\n=== Testing Endpoints ==="
          curl -I http://localhost:8080/static/images/logo.png || echo "Failed to fetch logo.png"
          
          # Kill the server
          kill $SERVER_PID
